<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>å³æ™‚çµæœ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š å³æ™‚è©•åˆ†çµæœ</h1>
        <button id="refresh-btn">é‡æ–°æ•´ç†</button>
        <div id="scorer-count">æ­£åœ¨è¼‰å…¥...</div>
        
        <h2>ç¸½åˆ†æ’å (ä¾å¹³å‡ç¸½åˆ†)</h2>
        <table id="total-results-table">
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>çµ„åˆ¥</th>
                    <th>å¹³å‡ç¸½åˆ†</th>
                </tr>
            </thead>
            <tbody id="total-results-body"></tbody>
        </table>

        <h2>è©³ç´°é …ç›®å¹³å‡</h2>
        <div id="detailed-area" style="overflow-x:auto;">
            <table id="detailed-table">
                <thead id="detailed-head"></thead>
                <tbody id="detailed-body"></tbody>
            </table>
        </div>
        
        <div class="nav-links">
            <a href="/scorer.html" target="_blank">æˆ‘ä¹Ÿè¦è©•åˆ†</a>
        </div>
    </div>
    <script>
        const detailedHead = document.getElementById('detailed-head');
        const detailedBody = document.getElementById('detailed-body');
        const totalBody = document.getElementById('total-results-body');
        const scorerCountDiv = document.getElementById('scorer-count');
        const refreshBtn = document.getElementById('refresh-btn');

        refreshBtn.onclick = loadData;

        async function loadData() {
            try {
                scorerCountDiv.textContent = 'æ­£åœ¨è¼‰å…¥...';
                
                // åŒæ™‚å–å¾—è¨­å®šæª”å’Œçµæœ
                const [configRes, resultsRes] = await Promise.all([
                    fetch('/api/config'),
                    fetch('/api/results')
                ]);

                if (!configRes.ok || !resultsRes.ok) {
                    throw new Error('ç„¡æ³•å–å¾—è³‡æ–™');
                }

                const config = await configRes.json();
                const results = await resultsRes.json();
                
                // æ›´æ–°è©•åˆ†äººæ•¸
                scorerCountDiv.textContent = `ç›®å‰å·²æœ‰ ${results.scorerCount} ä½è©•åˆ†è€…æäº¤ã€‚`;

                // 1. å»ºç«‹ç¸½åˆ†æ’åè¡¨æ ¼
                totalBody.innerHTML = '';
                results.groupTotals.forEach((group, index) => {
                    totalBody.innerHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${group.group_name}</td>
                            <td>${parseFloat(group.group_average).toFixed(2)}</td>
                        </tr>
                    `;
                });

                // 2. å»ºç«‹è©³ç´°é …ç›®è¡¨æ ¼
                // 2a. æ¨™é ­
                let headRow = '<tr><th>çµ„åˆ¥</th>';
                config.items.forEach(item => {
                    headRow += `<th>${item} (å‡åˆ†)</th>`;
                });
                headRow += '</tr>';
                detailedHead.innerHTML = headRow;

                // 2b. å…§å®¹
                detailedBody.innerHTML = '';
                config.groups.forEach(group => {
                    let bodyRow = `<tr><td><strong>${group}</strong></td>`;
                    config.items.forEach(item => {
                        // å¾ results.itemAvgs æ‰¾å‡ºå°æ‡‰çš„åˆ†æ•¸
                        const scoreData = results.itemAvgs.find(
                            s => s.group_name === group && s.item_name === item
                        );
                        const avg = scoreData ? parseFloat(scoreData.average).toFixed(2) : 'N/A';
                        bodyRow += `<td>${avg}</td>`;
                    });
                    bodyRow += '</tr>';
                    detailedBody.innerHTML += bodyRow;
                });

            } catch (e) {
                scorerCountDiv.textContent = `è¼‰å…¥å¤±æ•—: ${e.message}`;
                console.error(e);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥ä¸€æ¬¡
        window.onload = loadData;
        // æ¯15ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
        setInterval(loadData, 15000);
    </script>
</body>
</html>