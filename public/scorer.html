<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è©•åˆ†è¼¸å…¥é é¢</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“ è©•åˆ†è¼¸å…¥</h1>
        
        <div class="scorer-name">
            <label for="scorer-name">æ‚¨çš„å§“å/ä»£è™Ÿï¼š</label>
            <input type="text" id="scorer-name" placeholder="è«‹è¼¸å…¥æ‚¨çš„åå­—">
        </div>

        <div id="loading">æ­£åœ¨è¼‰å…¥è¨­å®š...</div>
        <div id="scoring-area" style="overflow-x:auto;">
            <table id="scoring-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        
        <button id="submit-scores">æäº¤åˆ†æ•¸</button>
        <div id="message" class="message-box"></div>
        
        <div class="nav-links">
            <a href="/results.html" target="_blank">æŸ¥çœ‹å³æ™‚çµæœ</a>
        </div>
    </div>

    <script>
        let config = { items: [], groups: [] };
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const scorerNameInput = document.getElementById('scorer-name');
        const messageDiv = document.getElementById('message');
        const loadingDiv = document.getElementById('loading');

        // è¼‰å…¥é é¢æ™‚, å¾ä¼ºæœå™¨å–å¾—è¨­å®šä¸¦å»ºç«‹è¡¨æ ¼
        window.onload = async () => {
            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error('ç„¡æ³•å–å¾—è¨­å®š');
                config = await res.json();
                
                if (config.items.length === 0 || config.groups.length === 0) {
                    loadingDiv.textContent = 'ç³»çµ±å°šæœªè¨­å®šè©•åˆ†é …ç›®ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚';
                    return;
                }

                buildTable();
                loadingDiv.style.display = 'none';

            } catch (e) {
                loadingDiv.textContent = `éŒ¯èª¤: ${e.message}`;
                console.error(e);
            }
        };

        function buildTable() {
            // 1. å»ºç«‹æ¨™é ­ (Items)
            let headRow = '<tr><th>çµ„åˆ¥</th>';
            config.items.forEach(item => {
                headRow += `<th>${item}</th>`;
            });
            headRow += '</tr>';
            tableHead.innerHTML = headRow;

            // 2. å»ºç«‹è¡¨æ ¼ä¸»é«” (Groups)
            tableBody.innerHTML = '';
            config.groups.forEach((group) => {
                let bodyRow = `<tr><td><strong>${group}</strong></td>`;
                config.items.forEach((item) => {
                    // ä½¿ç”¨ data-group å’Œ data-item å±¬æ€§ä¾†æ¨™è¨˜
                    bodyRow += `<td><input type="number" class="score-input" min="0" max="100" data-group="${group}" data-item="${item}" placeholder="0-100"></td>`;
                });
                bodyRow += '</tr>';
                tableBody.innerHTML += bodyRow;
            });
        }

        // æäº¤åˆ†æ•¸
        document.getElementById('submit-scores').onclick = async () => {
            const scorerName = scorerNameInput.value.trim();
            if (!scorerName) {
                showMessage('è«‹å…ˆè¼¸å…¥æ‚¨çš„å§“å/ä»£è™Ÿ', 'error');
                scorerNameInput.focus();
                return;
            }

            const scores = {};
            let allFilled = true;
            document.querySelectorAll('.score-input').forEach(input => {
                const group = input.dataset.group;
                const item = input.dataset.item;
                const score = parseInt(input.value, 10);

                if (isNaN(score) || input.value.trim() === '') {
                    allFilled = false;
                    input.style.borderColor = 'red';
                } else {
                    input.style.borderColor = '#ccc';
                }
                
                if (!scores[group]) scores[group] = {};
                scores[group][item] = score;
            });

            if (!allFilled) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰åˆ†æ•¸æ¬„ä½', 'error');
                return;
            }

            // å‚³é€è³‡æ–™åˆ°å¾Œç«¯
            try {
                const res = await fetch('/api/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scorerName, scores })
                });
                const data = await res.json();
                
                if (res.ok) {
                    showMessage('åˆ†æ•¸æäº¤æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„è©•åˆ†ã€‚', 'success');
                } else {
                    showMessage(`æäº¤å¤±æ•—: ${data.message}`, 'error');
                }
            } catch (e) {
                showMessage(`æäº¤å¤±æ•—: ${e.message}`, 'error');
            }
        };

        function showMessage(msg, type) {
            messageDiv.textContent = msg;
            messageDiv.className = `message-box ${type}`;
        }
    </script>
</body>
</html>